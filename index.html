<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FNAF: Final Fixed Version</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        /* ==================== STYLES ==================== */
        body { background-color: #050505; margin: 0; overflow: hidden; font-family: 'Courier New', Courier, monospace; user-select: none; }
        
        /* VISUAL FX */
        #fx-static {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 800;
            opacity: 0.03; background-image: url('https://media.giphy.com/media/oEI9uBYSzLpBK/giphy.gif'); mix-blend-mode: screen;
        }
        #scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 801;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%); background-size: 100% 4px;
        }
        #nv-overlay {
            display: none; position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index: 850;
            background: rgba(0, 255, 0, 0.15); box-shadow: inset 0 0 100px #00ff00; mix-blend-mode: add;
        }

        /* SCREENS */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #fff; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 2000;
        }
        .hidden { display: none !important; }

        h1 { font-size: 50px; text-shadow: 2px 2px red; margin-bottom: 10px; text-align: center; }
        .btn {
            padding: 15px 40px; border: 2px solid #fff; background: #111; color: #fff;
            font-size: 20px; cursor: pointer; margin: 10px; width: 300px; text-transform: uppercase; transition: 0.2s;
        }
        .btn:hover { background: #fff; color: #000; }
        input { background: #222; border: 1px solid #555; color: white; padding: 10px; font-size: 18px; text-align: center; width: 280px; }

        /* LOBBY */
        #role-selector { display: flex; gap: 10px; margin: 20px; }
        .role-btn { width: 140px; border: 1px solid #555; padding: 10px; cursor: pointer; text-align: center; }
        .role-active { background: #0f0; color: black; font-weight: bold; border: 2px solid white; }

        /* HUD */
        #hud { display: none; width: 100%; height: 100%; position: absolute; top:0; left:0; pointer-events: none; }
        #clock { position: absolute; top: 20px; right: 30px; font-size: 40px; font-weight: bold; text-shadow: 2px 2px 0 #000; color: white; }
        #power-ui { position: absolute; bottom: 20px; left: 30px; font-size: 24px; color: white; text-shadow: 1px 1px 0 #000; }
        .pwr-bar { display: inline-block; width: 20px; height: 10px; background: #333; margin-right: 2px; border: 1px solid #555; }
        .pwr-on { background: lime; box-shadow: 0 0 5px lime; }
        
        #conn-status { position: absolute; top: 20px; left: 20px; color: #555; font-size: 12px; border: 1px solid #333; padding: 5px; }
        .status-dot { display: inline-block; width: 10px; height: 10px; background: red; border-radius: 50%; margin-right: 5px; }

        /* INTERACTIVE */
        #flash-btn {
            position: absolute; bottom: 100px; right: 30px; 
            width: 80px; height: 80px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 2px solid #fff;
            pointer-events: auto; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 10px; text-align: center; color: white;
        }
        #monitor-trigger {
            position: absolute; bottom: 0; left: 30%; width: 40%; height: 40px;
            background: rgba(255,255,255,0.1); border: 1px solid white; border-bottom: none;
            cursor: pointer; pointer-events: auto; display: flex; align-items: center; justify-content: center;
            color: #aaa; transition: 0.2s;
        }
        #monitor-trigger:hover { background: rgba(255,255,255,0.3); color: white; }

        /* CAMS */
        #cam-ui { display: none; width: 100%; height: 100%; background: rgba(0,0,0,0.2); pointer-events: none; }
        #map-box {
            position: absolute; bottom: 70px; right: 40px; width: 300px; height: 250px;
            background: rgba(0,0,0,0.85); border: 2px solid #555; pointer-events: auto;
        }
        .map-btn {
            position: absolute; background: #333; border: 1px solid #666; color: #ccc;
            font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .map-active { background: #adff2f; color: black; border-color: white; }
        #cam-title { position: absolute; top: 40px; left: 50px; font-size: 30px; color: white; text-shadow: 2px 2px 0 black; }
        
        /* JUMPSCARE */
        #scare-screen { display: none; background: black; z-index: 5000; align-items: center; justify-content: center; overflow: hidden; }
        #scare-img { width: 100%; height: 100%; object-fit: cover; animation: violent-shake 0.15s infinite; }
        @keyframes violent-shake {
            0% { transform: translate(0, 0) scale(1.1); }
            25% { transform: translate(-10px, 10px) scale(1.2); }
            50% { transform: translate(10px, -10px) scale(1.1); }
            75% { transform: translate(-10px, -10px) scale(1.2) rotate(2deg); }
            100% { transform: translate(0, 0) scale(1.1); }
        }
    </style>
</head>
<body>

    <div id="fx-static"></div>
    <div id="scanlines"></div>
    <div id="nv-overlay"></div>

    <div id="menu" class="screen">
        <h1>FIVE NIGHTS</h1>
        <p style="color:#888;">FINAL UPDATE</p>
        <button class="btn" onclick="startSolo()">SINGLE PLAYER</button>
        <button class="btn" onclick="openMultiMenu()">MULTIPLAYER</button>
    </div>

    <div id="multi-menu" class="screen hidden">
        <h1>MULTIPLAYER</h1>
        <p style="font-size:14px; color:#aaa; max-width:400px; text-align:center;">
            Host on Replit or GitHub. Do not just open the file.
        </p>
        <button class="btn" onclick="setupHost()">CREATE LOBBY</button>
        <br>
        <input type="text" id="join-code" placeholder="ENTER 4-DIGIT ID" maxlength="4">
        <p id="connect-error" style="color:red; display:none;">LOBBY NOT FOUND / TIMEOUT</p>
        <button class="btn" id="join-btn" onclick="joinLobby()">JOIN LOBBY</button>
        <br>
        <button class="btn" style="width:150px; font-size:16px; border-color:#555; color:#888;" onclick="location.reload()">BACK</button>
    </div>

    <div id="lobby-screen" class="screen hidden">
        <h1>LOBBY</h1>
        <p style="color:#aaa;">SHARE THIS CODE:</p>
        <p id="lobby-code" style="font-size:40px; color:lime; font-weight:bold; letter-spacing: 5px; border:2px dashed #555; padding:10px;">....</p>
        <p id="lobby-status">WAITING FOR PLAYER 2...</p>
        <div id="role-selector">
            <div id="role-guard" class="role-btn role-active" onclick="selectRole('GUARD')">PLAY AS<br>GUARD</div>
            <div id="role-anim" class="role-btn" onclick="selectRole('MONSTER')">PLAY AS<br>FREDDY</div>
        </div>
        <button id="start-match-btn" class="btn" onclick="hostStartGame()" style="display:none; border-color:lime; color:lime;">START GAME</button>
    </div>

    <div id="join-wait" class="screen hidden">
        <h1>CONNECTING...</h1>
        <div class="pwr-bar pwr-on" style="animation: blink 1s infinite;"></div>
    </div>

    <div id="hud">
        <div id="conn-status"><span class="status-dot"></span><span id="conn-text">OFFLINE</span></div>
        <div id="clock">12 AM</div>
        <div id="power-ui">
            POWER: <span id="pwr-val">100</span>% <br>
            USAGE: <span class="pwr-bar pwr-on"></span><span class="pwr-bar" id="u-2"></span><span class="pwr-bar" id="u-3"></span><span class="pwr-bar" id="u-4"></span>
        </div>
        <div id="flash-btn" onmousedown="toggleFlashlight()">FLASH</div>

        <div id="cam-ui">
            <div id="cam-border"></div>
            <div id="cam-title">CAM 1A</div>
            <div id="map-box">
                <div id="m-1a" class="map-btn map-active" style="top:20px; left:130px; width:40px; height:30px;" onclick="setCam('1A')">1A</div>
                <div id="m-1b" class="map-btn" style="top:60px; left:120px; width:60px; height:50px;" onclick="setCam('1B')">1B</div>
                <div id="m-4a" class="map-btn" style="top:130px; left:160px; width:20px; height:60px;" onclick="setCam('4A')">4A</div>
                <div id="m-4b" class="map-btn" style="top:200px; left:160px; width:20px; height:20px;" onclick="setCam('4B')">4B</div>
                <div id="m-2a" class="map-btn" style="top:130px; left:100px; width:20px; height:60px;" onclick="setCam('2A')">2A</div>
                <div id="m-2b" class="map-btn" style="top:200px; left:100px; width:20px; height:20px;" onclick="setCam('2B')">2B</div>
                <div style="position:absolute; bottom:5px; left:135px; color:#aaa; font-size:10px;">YOU</div>
            </div>
        </div>
        <div id="monitor-trigger" onmousedown="toggleMonitor()"><span id="mon-txt">OPEN MONITOR</span></div>
    </div>

    <div id="scare-screen" class="screen">
        <img id="scare-img" src="https://i.imgur.com/P3a8ikL.jpeg">
        <h1 style="position:absolute; color:red; font-size:80px; text-shadow: 4px 4px 0 black;">GAME OVER</h1>
    </div>

    <a-scene loading-screen="enabled: false" background="color: #000" fog="type: exponential; color: #000; density: 0.15">
        <a-assets>
            <img id="wall-tex" src="wall.png"> 
            <img id="floor-tex" src="checker.png">
            <a-asset-item id="freddy-glb" src="freddy.glb"></a-asset-item>
            <audio id="sfx-ambience" src="https://cdn.pixabay.com/download/audio/2022/10/14/audio_997996c56b.mp3" loop></audio>
            <audio id="sfx-blip" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8b8433b5d.mp3"></audio>
            <audio id="sfx-scare" src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3"></audio>
        </a-assets>

        <a-entity id="map-root">
            <a-entity position="0 0 15">
                <a-plane rotation="-90 0 0" width="8" height="6" color="#333" src="#floor-tex" repeat="4 4"></a-plane>
                <a-plane position="0 4 0" rotation="90 0 0" width="8" height="6" color="#111"></a-plane>
                
                <a-box position="0 2 2.9" width="8" height="4" depth="0.2" color="#777" src="#wall-tex"></a-box>
                
                <a-box position="0 1 -2.9" width="8" height="2" depth="0.2" color="#777" src="#wall-tex"></a-box>
                <a-box position="0 3.5 -2.9" width="8" height="1" depth="0.2" color="#777" src="#wall-tex"></a-box>
                <a-box position="-3 2.5 -2.9" width="2" height="1" depth="0.2" color="#777" src="#wall-tex"></a-box>
                <a-box position="3 2.5 -2.9" width="2" height="1" depth="0.2" color="#777" src="#wall-tex"></a-box>

                <a-box position="-3.9 2 -2" width="0.2" height="4" depth="2" color="#666" src="#wall-tex"></a-box>
                <a-box position="-3.9 2 2" width="0.2" height="4" depth="2" color="#666" src="#wall-tex"></a-box>
                <a-box position="-3.9 3.5 0" width="0.2" height="1" depth="2" color="#666" src="#wall-tex"></a-box> <a-box position="3.9 2 -2" width="0.2" height="4" depth="2" color="#666" src="#wall-tex"></a-box>
                <a-box position="3.9 2 2" width="0.2" height="4" depth="2" color="#666" src="#wall-tex"></a-box>
                <a-box position="3.9 3.5 0" width="0.2" height="1" depth="2" color="#666" src="#wall-tex"></a-box> <a-entity position="0 1.2 -1.5" scale="0.5 0.5 0.5">
                     <a-cylinder color="#222" height="0.2" radius="0.3"></a-cylinder> <a-cylinder color="#444" height="0.6" radius="0.05" position="0 0.3 0"></a-cylinder> <a-entity position="0 0.6 0.1" animation="property: rotation; to: 0 0 -360; loop: true; dur: 200; easing: linear">
                        <a-box color="#111" width="1" height="0.1" depth="0.02"></a-box>
                        <a-box color="#111" width="1" height="0.1" depth="0.02" rotation="0 0 90"></a-box>
                     </a-entity>
                     <a-cylinder color="#333" radius="0.6" height="0.1" rotation="90 0 0" position="0 0.6 0.1" material="opacity: 0.3; transparent: true; side: double"></a-cylinder> </a-entity>
                
                <a-box position="0 1 -1.8" width="4" height="0.1" depth="1.5" color="#222"></a-box>

                <a-box position="-3.7 1.5 -0.8" width="0.1" height="0.2" depth="0.1" color="red" class="clickable" onclick="clickDoor('L')"></a-box>
                <a-box position="-3.7 1.2 -0.8" width="0.1" height="0.2" depth="0.1" color="white" class="clickable" onclick="clickLight('L')"></a-box>
                <a-box position="3.7 1.5 -0.8" width="0.1" height="0.2" depth="0.1" color="red" class="clickable" onclick="clickDoor('R')"></a-box>
                <a-box position="3.7 1.2 -0.8" width="0.1" height="0.2" depth="0.1" color="white" class="clickable" onclick="clickLight('R')"></a-box>

                <a-box id="door-L" position="-3.9 5 0" width="0.1" height="4" depth="1.8" color="#333"></a-box>
                <a-box id="door-R" position="3.9 5 0" width="0.1" height="4" depth="1.8" color="#333"></a-box>
                
                <a-light type="point" intensity="0.2" distance="5" color="#aaf" position="0 3 0"></a-light>
            </a-entity>

            <a-entity position="-7 0 15"> 
                <a-plane rotation="-90 0 0" width="4" height="20" color="#222" src="#floor-tex"></a-plane>
                <a-box position="-2.1 2 0" width="0.2" height="4" depth="20" color="#444" src="#wall-tex"></a-box>
            </a-entity>
            <a-entity position="7 0 15"> 
                <a-plane rotation="-90 0 0" width="4" height="20" color="#222" src="#floor-tex"></a-plane>
                <a-box position="2.1 2 0" width="0.2" height="4" depth="20" color="#444" src="#wall-tex"></a-box>
            </a-entity>

            <a-entity position="0 0 0"> <a-plane rotation="-90 0 0" width="20" height="20" color="#222" src="#floor-tex" repeat="10 10"></a-plane> </a-entity>
        </a-entity>

        <a-entity id="freddy" position="0 1.5 0">
            <a-gltf-model src="#freddy-glb"></a-gltf-model>
            <a-box color="brown" position="0 1 0" scale="1 2 1" visible="false"></a-box> 
        </a-entity>

        <a-entity id="player-rig" position="0 1.6 15" rotation="0 180 0">
            <a-camera id="head" look-controls="pointerLockEnabled: true" wasd-controls="enabled: false">
                <a-cursor color="red" scale="0.5 0.5 0.5" raycaster="objects: .clickable"></a-cursor>
                <a-light id="flashlight" type="spot" color="#fff" intensity="0" angle="30" penumbra="0.3" distance="30" position="0.2 -0.2 0"></a-light>
            </a-camera>
        </a-entity>
    </a-scene>

    <script>
        // --- CONFIG ---
        const CAM_POS = {
            '1A': '0 3 0',   // Stage
            '1B': '0 3 8',   // Dining
            '4A': '7 3 15',  // Right Hall
            '4B': '7 3 18',  // Right Corner
            '2A': '-7 3 15', // Left Hall
            '2B': '-7 3 18'  // Left Corner
        };

        // Solo AI Path
        const AI_PATH = ['1A', '1B', '4A', '4B', 'OFFICE'];
        let freddyIndex = 0;

        let game = {
            active: false, mode: 'SOLO', role: 'GUARD',
            power: 100, hour: 12, monitor: false, flashlight: false,
            doors: {L:false, R:false}, lights: {L:false, R:false}
        };

        let peer = null, conn = null;
        const PREFIX = "fnaf-final-fix-v4-"; 
        
        const PEER_CONFIG = {
            config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] }
        };

        // --- CONTROLS ---
        window.addEventListener('keydown', (e) => { 
            if(e.code === 'KeyF') toggleFlashlight(); 
        });

        // --- MENU & INIT ---
        function openMultiMenu() {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('multi-menu').classList.remove('hidden');
        }

        function startSolo() {
            game.mode = 'SOLO';
            launchGame('GUARD');
            // AI Loop for Solo Mode
            setInterval(() => {
                if(!game.active) return;
                // Random chance to move every 5 seconds
                if(Math.random() > 0.4) {
                    moveFreddySolo();
                }
            }, 5000);
        }

        function moveFreddySolo() {
            freddyIndex++;
            if(freddyIndex >= AI_PATH.length) {
                // He is at the office
                if(!game.doors.R) { // Coming from Right Hall
                    jumpscare();
                } else {
                    // Blocked
                    freddyIndex = 0; // Reset
                    document.getElementById('freddy').setAttribute('position', '0 1.5 0'); // Back to stage
                }
                return;
            }
            
            // Move Visual
            let loc = AI_PATH[freddyIndex];
            if(loc === 'OFFICE') return; // Wait for next tick to attack
            
            let coords = CAM_POS[loc].split(' ');
            // Adjust Y for model
            document.getElementById('freddy').setAttribute('position', `${coords[0]} 1.5 ${coords[2]}`);
        }

        function setupHost() {
            const id = Math.floor(Math.random() * 9000 + 1000);
            if(peer) peer.destroy();
            peer = new Peer(PREFIX + id, PEER_CONFIG);
            document.getElementById('multi-menu').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('lobby-code').innerText = id;
            peer.on('connection', (c) => {
                conn = c;
                conn.on('open', () => {
                    document.getElementById('lobby-status').innerText = "PLAYER 2 CONNECTED!";
                    document.getElementById('lobby-status').style.color = "lime";
                    document.getElementById('start-match-btn').style.display = "block";
                    setupNetEvents();
                });
            });
        }

        function joinLobby() {
            const inputId = document.getElementById('join-code').value.trim();
            if(inputId.length < 4) return;
            const joinBtn = document.getElementById('join-btn');
            joinBtn.innerText = "CONNECTING...";
            if(peer) peer.destroy();
            peer = new Peer(null, PEER_CONFIG); 
            peer.on('open', () => {
                conn = peer.connect(PREFIX + inputId, { reliable: true });
                conn.on('open', () => {
                    document.getElementById('multi-menu').classList.add('hidden');
                    document.getElementById('join-wait').classList.remove('hidden');
                    setupNetEvents();
                });
                setTimeout(() => { if(!conn || !conn.open) alert("Connection Timed Out. Try Mobile Hotspot."); }, 15000);
            });
        }

        function setupNetEvents() {
            document.getElementById('conn-status').style.borderColor = 'lime';
            document.getElementById('conn-text').innerText = "CONNECTED";
            document.getElementById('conn-text').style.color = "lime";
            
            conn.on('data', (data) => {
                if(data.type === 'START') launchGame(data.role);
                if(data.type === 'SYNC') { game.doors = data.doors; game.lights = data.lights; updateWorldVisuals(); }
                if(data.type === 'MOVE') {
                    const fred = document.getElementById('freddy');
                    fred.setAttribute('position', data.pos);
                    fred.setAttribute('visible', true);
                    // Multiplayer Kill Logic
                    if(data.z > 14 && game.role === 'GUARD') {
                        // Check if he is Left or Right (simple check based on x)
                        let isRight = data.x > 0;
                        if(isRight && !game.doors.R) jumpscare();
                        else if(!isRight && !game.doors.L) jumpscare();
                    }
                }
                if(data.type === 'SCARE') jumpscare();
            });
        }

        function selectRole(r) {
            game.role = r;
            document.getElementById('role-guard').className = r==='GUARD' ? 'role-btn role-active' : 'role-btn';
            document.getElementById('role-anim').className = r==='MONSTER' ? 'role-btn role-active' : 'role-btn';
        }

        function hostStartGame() {
            if(!conn || !conn.open) return;
            let hostRole = game.role;
            let joinRole = (hostRole === 'GUARD') ? 'MONSTER' : 'GUARD';
            conn.send({ type: 'START', role: joinRole });
            launchGame(hostRole);
        }

        function launchGame(role) {
            game.role = role;
            game.active = true;
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('sfx-ambience').play().catch(()=>{});

            if(role === 'GUARD') {
                document.getElementById('hud').style.display = 'block';
                document.getElementById('freddy').setAttribute('visible', true);
                setInterval(clockTick, 8000);
                setInterval(powerTick, 1000);
            } else {
                document.getElementById('hud').style.display = 'none';
                document.getElementById('nv-overlay').style.display = 'block';
                document.getElementById('freddy').setAttribute('visible', false);
                const rig = document.getElementById('player-rig');
                rig.setAttribute('wasd-controls', 'enabled: true; acceleration: 25'); 
                rig.setAttribute('position', '0 1.6 0'); // Start on stage
                
                // Add Night Vision Light
                const nvLight = document.createElement('a-entity');
                nvLight.setAttribute('light', 'type: spot; color: #88ff88; intensity: 2; angle: 80; distance: 40;');
                rig.querySelector('#head').appendChild(nvLight);
                document.querySelector('a-scene').setAttribute('fog', 'density: 0');

                setInterval(() => {
                    if(!game.active) return;
                    const pos = rig.getAttribute('position');
                    conn.send({ type: 'MOVE', pos: pos, x: pos.x, z: pos.z });
                }, 100);
            }
        }

        function clockTick() {
            if(!game.active) return;
            game.hour++;
            if(game.hour === 13) game.hour = 1;
            document.getElementById('clock').innerText = game.hour + (game.hour===12?" AM":" AM");
            if(game.hour === 6) { game.active=false; alert("6 AM - SURVIVED"); location.reload(); }
        }

        function powerTick() {
            if(!game.active) return;
            let usage = 1;
            if(game.doors.L) usage++; if(game.doors.R) usage++;
            if(game.lights.L) usage++; if(game.lights.R) usage++;
            if(game.monitor) usage++;
            if(game.flashlight) usage++;
            for(let i=2; i<=4; i++) document.getElementById('u-'+i).className = "pwr-bar "+(i<=usage?"pwr-on":"");
            game.power -= (usage * 0.2);
            if(game.power <= 0) { game.power = 0; powerOutage(); }
            document.getElementById('pwr-val').innerText = Math.floor(game.power);
        }

        function clickDoor(side) {
            if(game.power <= 0 || game.role !== 'GUARD') return;
            game.doors[side] = !game.doors[side];
            updateWorldVisuals();
            if(game.mode === 'MULTI' && conn) conn.send({ type: 'SYNC', doors: game.doors, lights: game.lights });
        }

        function clickLight(side) {
            if(game.power <= 0 || game.role !== 'GUARD') return;
            game.lights[side] = !game.lights[side];
            if(side==='L' && game.lights.L) game.lights.R = false;
            if(side==='R' && game.lights.R) game.lights.L = false;
            updateWorldVisuals();
            if(game.mode === 'MULTI' && conn) conn.send({ type: 'SYNC', doors: game.doors, lights: game.lights });
        }

        function updateWorldVisuals() {
            // SLIDING DOORS
            const dL = document.getElementById('door-L');
            const dR = document.getElementById('door-R');
            
            // If door is closed, move it down (y=2). If open, move it up (y=5).
            dL.setAttribute('position', `-3.9 ${game.doors.L ? 2 : 5} 0`);
            dR.setAttribute('position', `3.9 ${game.doors.R ? 2 : 5} 0`);
            
            if(game.lights.L || game.lights.R) document.getElementById('sfx-blip').play();
        }

        function toggleFlashlight() {
            if(game.power <= 0 || game.role !== 'GUARD') return;
            game.flashlight = !game.flashlight;
            document.getElementById('flashlight').setAttribute('intensity', game.flashlight ? 2.5 : 0);
            document.getElementById('flash-btn').style.background = game.flashlight ? "white" : "rgba(255,255,255,0.1)";
            document.getElementById('flash-btn').style.color = game.flashlight ? "black" : "white";
        }

        function toggleMonitor() {
            if(game.power <= 0) return;
            game.monitor = !game.monitor;
            const ui = document.getElementById('cam-ui');
            const rig = document.getElementById('player-rig');
            
            if(game.monitor) {
                if(game.flashlight) toggleFlashlight(); 
                ui.style.display = 'block';
                document.getElementById('mon-txt').innerText = "CLOSE MONITOR";
                setCam('1A');
                document.getElementById('sfx-blip').play();
            } else {
                ui.style.display = 'none';
                document.getElementById('mon-txt').innerText = "OPEN MONITOR";
                // Return to Office
                rig.setAttribute('position', '0 1.6 15');
                rig.setAttribute('rotation', '0 180 0');
                document.querySelector('a-scene').setAttribute('fog', 'density: 0.15');
            }
        }

        function setCam(id) {
            document.querySelectorAll('.map-btn').forEach(b=>b.classList.remove('map-active'));
            document.getElementById('m-'+id.toLowerCase()).classList.add('map-active');
            document.getElementById('cam-title').innerText = "CAM " + id;
            
            const rig = document.getElementById('player-rig');
            const parts = CAM_POS[id].split(' ');
            rig.setAttribute('position', `${parts[0]} ${parts[1]} ${parts[2]}`);
            rig.setAttribute('rotation', '0 0 0'); // Look forward
            
            document.querySelector('a-scene').setAttribute('fog', 'density: 0.15');
            
            // Static FX
            const fx = document.getElementById('fx-static');
            fx.style.opacity = 0.3; setTimeout(()=>fx.style.opacity=0.03, 150);
            document.getElementById('sfx-blip').play();
        }

        function jumpscare() {
            if(!game.active) return;
            game.active = false;
            document.getElementById('hud').style.display='none';
            document.getElementById('cam-ui').style.display='none';
            document.getElementById('scare-screen').style.display='flex';
            document.getElementById('sfx-scare').play();
            setTimeout(()=>location.reload(), 3000);
        }

        function powerOutage() {
            if(game.monitor) toggleMonitor();
            if(game.flashlight) toggleFlashlight();
            document.getElementById('power-ui').style.color = 'red';
            setTimeout(jumpscare, 5000);
        }
    </script>
</body>
</html>
